<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.anipick.backend.ranking.mapper.RealTimeRankingMapper">
    <resultMap id="RankingResultMap" type="com.anipick.backend.ranking.dto.RealTimeRankingAnimesFromQueryDto">
        <id property="animeId" column="animeId"/>
        <result property="titleKor" column="titleKor"/>
        <result property="titleEng" column="titleEng"/>
        <result property="titleRom" column="titleRom"/>
        <result property="titleNat" column="titleNat"/>
        <result property="coverImageUrl" column="coverImageUrl"/>
        <result property="trending" column="trending"/>
        <result property="popularity" column="popularity"/>
    </resultMap>

    <select id="getRealTimeRanking" resultMap="RankingResultMap">
        SELECT
            DISTINCT(a.anime_id) AS animeId,
            a.title_kor AS titleKor,
            a.title_english AS titleEng,
            a.title_romaj AS titleRom,
            a.title_native AS titleNat,
            a.cover_image_url AS coverImageUrl,
            a.trending AS trending,
            a.popularity AS popularity
        FROM Anime AS a
        JOIN AnimeGenres AS ag
        ON a.anime_id = ag.anime_id
        WHERE 1 = 1
        <if test="genreId != null">
            AND ag.genre_id = #{genreId}
        </if>
        <!-- 성인 애니 제거 -->
            AND NOT EXISTS(
                SELECT 1
                FROM AnimeGenres as ag
                WHERE ag.anime_id = a.anime_id
                  AND ag.genre_id = 19
        )
        ORDER BY a.trending DESC, a.popularity DESC
    </select>

    <select id="getRealTimeRankingPaging" resultMap="RankingResultMap">
        SELECT
            DISTINCT(a.anime_id) AS animeId,
            a.title_kor AS titleKor,
            a.title_english AS titleEng,
            a.title_romaj AS titleRom,
            a.title_native AS titleNat,
            a.cover_image_url AS coverImageUrl,
            a.trending AS trending,
            a.popularity AS popularity
        FROM Anime AS a
        JOIN AnimeGenres AS ag
        ON a.anime_id = ag.anime_id
        WHERE 1 = 1
        <if test="genreId != null">
            AND ag.genre_id = #{genreId}
        </if>
        <if test="lastId != null and lastValue != null">
            AND (a.trending , a.popularity) &lt; (#{lastValue}, #{lastId})
        </if>
        <!-- 성인 애니 제거 -->
            AND NOT EXISTS(
                SELECT 1
                FROM AnimeGenres as ag
                WHERE ag.anime_id = a.anime_id
                  AND ag.genre_id = 19
        )
        ORDER BY a.trending DESC, a.popularity DESC
        LIMIT #{size}
    </select>
</mapper>