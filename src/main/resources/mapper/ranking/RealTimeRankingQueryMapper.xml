<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.anipick.backend.ranking.mapper.RealTimeRankingMapper">
    <resultMap id="RankingResultMap" type="RankingAnimesFromQueryDto">
        <id property="animeId" column="animeId"/>
        <result property="title" column="title"/>
        <result property="coverImageUrl" column="coverImageUrl"/>
        <result property="rank" column="rankNum"/>
        <collection property="genres" ofType="string" column="genreName"/>
    </resultMap>

    <select id="getRealTimeRanking" resultMap="RankingResultMap">
        SELECT
            a.anime_id AS animeId,
            a.title_kor AS title,
            a.cover_image_url AS coverImageUrl,
            rtar.rank_num AS rankNum,
            g.genre_kor AS genreName
        FROM Anime AS a
        JOIN RealTimeAnimeRanking AS rtar ON a.anime_id = rtar.anime_id
        JOIN Genres AS g ON rtar.genre_id = g.genre_id
        WHERE
        <if test="genre != null">
            g.genre_kor = #{genre}
        </if>
            AND DATE_FORMAT(rtar.rank_date, '%Y-%m-%d %H:%i') = #{rankDateTime}
        ORDER BY ar.rank_num
    </select>
</mapper>